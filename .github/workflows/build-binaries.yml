name: Build Binaries

on:
  workflow_dispatch:
    inputs:
      upload-artifacts:
        description: "Upload artifacts to GitHub"
        required: false
        default: true
        type: boolean
  pull_request:
    paths:
      - "packages/hooks-cli/**"
      - ".github/workflows/build-binaries.yml"
      - "bun.lock"
      - "package.json"
  push:
    branches:
      - main
    paths:
      - "packages/hooks-cli/**"
      - ".github/workflows/build-binaries.yml"

permissions:
  contents: read
  actions: write

env:
  BUN_VERSION: "1.2.20"

jobs:
  build-test-binaries:
    name: Build & Test Binaries
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: linux-x64
            binary-name: carabiner-linux
          - os: macos-latest # ARM64
            target: macos-arm64
            binary-name: carabiner-macos-arm64
          - os: macos-13 # Intel x64
            target: macos-x64
            binary-name: carabiner-macos-x64
          - os: windows-latest
            target: windows-x64
            binary-name: carabiner-windows.exe

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build CLI dependencies only
        run: bun run build --filter=@carabiner/hooks-cli...

      - name: Verify CLI dependencies
        run: |
          set -euo pipefail
          cd packages/hooks-cli
          # Check that all required files exist
          test -f "src/cli.ts" || (echo "âŒ CLI entry point missing" && exit 1)
          test -f "package.json" || (echo "âŒ package.json missing" && exit 1)
          echo "âœ… CLI dependencies verified"
        shell: bash

      - name: Build binary with enhanced options
        id: build
        run: |
          set -euo pipefail
          cd packages/hooks-cli

          # Read version from package.json
          CLI_VERSION=$(node -p "require('./package.json').version")
          echo "Building binary version: $CLI_VERSION"

          # Build with comprehensive options for production binary
          bun build src/cli.ts \
            --compile \
            --minify \
            --sourcemap=external \
            --target=bun \
            --outfile=../../${{ matrix.binary-name }} \
            --define "process.env.NODE_ENV=\"production\"" \
            --define "process.env.CLI_VERSION=\"$CLI_VERSION\"" \
            --external "fsevents"

          echo "binary_name=${{ matrix.binary-name }}" >> "$GITHUB_OUTPUT"
          echo "âœ… Binary built: ${{ matrix.binary-name }}"
        shell: bash

      - name: Set executable permissions (Unix)
        if: matrix.target != 'windows-x64'
        run: chmod +x ./"${{ steps.build.outputs.binary_name }}"

      - name: Binary info
        run: |
          set -euo pipefail
          if [[ "${{ matrix.target }}" != "windows-x64" ]]; then
            ls -la ./"${{ steps.build.outputs.binary_name }}"
            file ./"${{ steps.build.outputs.binary_name }}" || echo "file command not available"
          else
            ls -la ./"${{ steps.build.outputs.binary_name }}"
          fi
        shell: bash

      # Comprehensive smoke tests
      - name: Smoke Test - Version Command
        run: |
          set -euo pipefail
          echo "Testing --version command..."
          if [[ "${{ matrix.target }}" != "windows-x64" ]]; then
            ./"${{ steps.build.outputs.binary_name }}" --version
          else
            ./"${{ steps.build.outputs.binary_name }}" --version
          fi
        shell: bash

      - name: Smoke Test - Help Command
        run: |
          set -euo pipefail
          echo "Testing --help command..."
          if [[ "${{ matrix.target }}" != "windows-x64" ]]; then
            ./"${{ steps.build.outputs.binary_name }}" --help
          else
            ./"${{ steps.build.outputs.binary_name }}" --help
          fi
        shell: bash

      - name: Smoke Test - Command Help
        run: |
          set -euo pipefail
          echo "Testing validate --help command..."
          if [[ "${{ matrix.target }}" != "windows-x64" ]]; then
            ./"${{ steps.build.outputs.binary_name }}" validate --help
          else
            ./"${{ steps.build.outputs.binary_name }}" validate --help
          fi
        shell: bash

      - name: Smoke Test - Config Command
        run: |
          set -euo pipefail
          echo "Testing config --help command..."
          if [[ "${{ matrix.target }}" != "windows-x64" ]]; then
            ./"${{ steps.build.outputs.binary_name }}" config --help
          else
            ./"${{ steps.build.outputs.binary_name }}" config --help
          fi
        shell: bash

      - name: Smoke Test - Invalid Command
        run: |
          set -euo pipefail
          echo "Testing invalid command (should fail gracefully)..."
          if [[ "${{ matrix.target }}" != "windows-x64" ]]; then
            ./"${{ steps.build.outputs.binary_name }}" nonexistent-command || echo "âœ… Correctly failed for invalid command"
          else
            ./"${{ steps.build.outputs.binary_name }}" nonexistent-command || echo "âœ… Correctly failed for invalid command"
          fi
        shell: bash

      - name: Smoke Test - Verbose Mode
        run: |
          set -euo pipefail
          echo "Testing verbose mode..."
          if [[ "${{ matrix.target }}" != "windows-x64" ]]; then
            ./"${{ steps.build.outputs.binary_name }}" --verbose --help
          else
            ./"${{ steps.build.outputs.binary_name }}" --verbose --help
          fi
        shell: bash

      - name: Upload binary artifact
        if: github.event.inputs.upload-artifacts != 'false'
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.target }}
          path: ${{ steps.build.outputs.binary_name }}
          retention-days: 30
          compression-level: 9

  binary-integration-test:
    name: Integration Test Summary
    runs-on: ubuntu-latest
    needs: build-test-binaries
    steps:
      - name: Download all binary artifacts
        if: github.event.inputs.upload-artifacts != 'false'
        uses: actions/download-artifact@v4
        with:
          path: ./binaries/

      - name: Verify all binaries
        if: github.event.inputs.upload-artifacts != 'false'
        run: |
          set -euo pipefail
          echo "Verifying all built binaries..."

          expected_binaries=(
            "carabiner-linux"
            "carabiner-macos-arm64"
            "carabiner-macos-x64"
            "carabiner-windows.exe"
          )
          missing_binaries=()

          for binary in "${expected_binaries[@]}"; do
            if find binaries -name "$binary" -type f | grep -q ".*"; then
              echo "âœ… Found $binary"
              find binaries -name "$binary" -type f -exec ls -la {} \;
            else
              echo "âŒ Missing $binary"
              missing_binaries+=("$binary")
            fi
          done

          if [ ${#missing_binaries[@]} -gt 0 ]; then
            echo "Missing binaries: ${missing_binaries[*]}"
            exit 1
          fi

          echo "ðŸŽ‰ All binaries successfully built and tested!"

      - name: Binary build summary
        run: |
          set -euo pipefail
          echo "## Binary Build Summary ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Linux x64**: carabiner-linux" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **macOS ARM64**: carabiner-macos-arm64" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **macOS x64**: carabiner-macos-x64" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Windows x64**: carabiner-windows.exe" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All binaries passed smoke tests:" >> $GITHUB_STEP_SUMMARY
          echo "- Version command" >> $GITHUB_STEP_SUMMARY
          echo "- Help commands" >> $GITHUB_STEP_SUMMARY
          echo "- Invalid command handling" >> $GITHUB_STEP_SUMMARY
          echo "- Verbose mode" >> $GITHUB_STEP_SUMMARY
